<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Courses App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }
    .app {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 280px;
      border-right: 1px solid #ddd;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
      background: #f8f8f8;
    }
    .main {
      flex: 1;
      padding: 1rem 2rem;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .course-list button,
    .chapter-list button,
    .topic-list button {
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      background: none;
      padding: 0.25rem 0;
      cursor: pointer;
    }
    .chapter {
      margin-top: 0.75rem;
    }
    .topics {
      margin-left: 1rem;
    }
    .nav-buttons {
      margin-top: 1.5rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
    .nav-buttons button {
      padding: 0.5rem 1rem;
    }
    .quiz-question {
      margin-top: 1rem;
    }
    .quiz-answers button {
      display: block;
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h2>Courses</h2>
      <div id="course-list" class="course-list"></div>

      <div id="course-structure" style="margin-top:1rem;">
        <!-- Chapters + topics injected here -->
      </div>
    </aside>

    <main class="main">
      <header>
        <h1 id="content-title">Select a course</h1>
      </header>

      <article id="content-body">
        <!-- Chapter/topic content goes here -->
      </article>

      <div class="nav-buttons">
        <button id="prev-content" disabled>Prev</button>
        <button id="next-content" disabled>Next</button>
      </div>

      <section id="quiz-section" style="margin-top:2rem; display:none;">
        <h2 id="quiz-title">Quiz</h2>
        <div id="quiz-content">
          <!-- Quiz question/answers or summary -->
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = '/api.php';

    const state = {
      courses: [],
      currentCourse: null,
      currentChapterId: null,
      currentTopicId: null,
      flatTopics: [],
      quiz: null // { questions, index, answers }
    };

    async function apiGet(params) {
      const url = API_BASE + '?' + new URLSearchParams(params);
      const res = await fetch(url);
      if (!res.ok) throw new Error('API error');
      return res.json();
    }

    async function loadCourses() {
      const courses = await apiGet({ action: 'list_courses' });
      state.courses = courses;
      renderCourseList();
    }

    function renderCourseList() {
      const container = document.getElementById('course-list');
      container.innerHTML = '';
      state.courses.forEach(course => {
        const btn = document.createElement('button');
        btn.textContent = course.title;
        btn.onclick = () => selectCourse(course.id);
        container.appendChild(btn);
      });
    }

    async function selectCourse(courseId) {
      const course = await apiGet({ action: 'get_course', course_id: courseId });
      state.currentCourse = course;
      buildFlatTopics();
      renderCourseStructure();
      // select first topic by default
      if (state.flatTopics.length > 0) {
        selectTopic(state.flatTopics[0].topic.id);
      }
    }

    function buildFlatTopics() {
      state.flatTopics = [];
      if (!state.currentCourse) return;
      state.currentCourse.chapters
        .sort((a, b) => a.sort_order - b.sort_order)
        .forEach(ch => {
          const topics = (ch.topics || []).slice().sort((a, b) => a.sort_order - b.sort_order);
          topics.forEach(t => {
            state.flatTopics.push({ chapter: ch, topic: t });
          });
        });
    }

    function renderCourseStructure() {
      const container = document.getElementById('course-structure');
      const course = state.currentCourse;
      if (!course) {
        container.innerHTML = '';
        return;
      }
      let html = `<h3>${course.title}</h3>`;
      course.chapters
        .slice()
        .sort((a, b) => a.sort_order - b.sort_order)
        .forEach(ch => {
          html += `<div class="chapter">
                     <strong>${ch.title}</strong>
                     <div class="topics">`;
          (ch.topics || []).slice().sort((a, b) => a.sort_order - b.sort_order)
            .forEach(t => {
              html += `<button data-topic-id="${t.id}">${t.title}</button>`;
            });
          html += `  </div>
                   </div>`;
        });
      container.innerHTML = html;

      container.querySelectorAll('button[data-topic-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const topicId = parseInt(btn.getAttribute('data-topic-id'), 10);
          selectTopic(topicId);
        });
      });
    }

    function selectTopic(topicId) {
      const pair = state.flatTopics.find(p => p.topic.id === topicId);
      if (!pair) return;
      state.currentChapterId = pair.chapter.id;
      state.currentTopicId = pair.topic.id;
      renderContent(pair.chapter, pair.topic);
      updatePrevNextButtons();
      resetQuiz();
    }

    function renderContent(chapter, topic) {
      document.getElementById('content-title').textContent = topic.title;
      document.getElementById('content-body').innerHTML =
        (topic.content || '') + (chapter.content ? `<hr>${chapter.content}` : '');

      const quizSection = document.getElementById('quiz-section');
      quizSection.style.display = 'block';
      document.getElementById('quiz-title').textContent = 'Quiz for: ' + topic.title;
      document.getElementById('quiz-content').innerHTML =
        `<button id="start-quiz">Start quiz</button>`;
      document.getElementById('start-quiz').onclick = startQuiz;
    }

    function updatePrevNextButtons() {
      const idx = state.flatTopics.findIndex(p => p.topic.id === state.currentTopicId);
      const prevBtn = document.getElementById('prev-content');
      const nextBtn = document.getElementById('next-content');

      prevBtn.disabled = idx <= 0;
      nextBtn.disabled = idx < 0 || idx >= state.flatTopics.length - 1;

      prevBtn.onclick = () => {
        if (idx > 0) {
          const prev = state.flatTopics[idx - 1];
          selectTopic(prev.topic.id);
        }
      };
      nextBtn.onclick = () => {
        if (idx < state.flatTopics.length - 1) {
          const next = state.flatTopics[idx + 1];
          selectTopic(next.topic.id);
        }
      };
    }

    async function startQuiz() {
      const topicId = state.currentTopicId;
      const data = await apiGet({ action: 'get_topic_quiz', topic_id: topicId });
      state.quiz = {
        topicId,
        questions: data.questions || [],
        index: 0,
        answers: []
      };
      renderQuizQuestion();
    }

    function resetQuiz() {
      state.quiz = null;
      const quizContent = document.getElementById('quiz-content');
      if (quizContent) quizContent.innerHTML = '';
    }

    function renderQuizQuestion() {
      const qc = document.getElementById('quiz-content');
      const quiz = state.quiz;
      if (!quiz || quiz.questions.length === 0) {
        qc.innerHTML = '<p>No quiz for this topic.</p>';
        return;
      }
      if (quiz.index >= quiz.questions.length) {
        renderQuizSummary();
        return;
      }
      const q = quiz.questions[quiz.index];
      const selected = quiz.answers[quiz.index]?.answer_id;

      let html = `<div class="quiz-question">
                    <h3>Question ${quiz.index + 1} of ${quiz.questions.length}</h3>
                    <p>${q.question_text}</p>
                    <div class="quiz-answers">`;
      q.answers.forEach(a => {
        const isSelected = selected === a.id;
        html += `<button data-answer-id="${a.id}" ${isSelected ? 'style="font-weight:bold;"' : ''}>
                   ${a.answer_text}
                 </button>`;
      });
      html += `</div>
               <div class="nav-buttons">
                 <button id="quiz-prev" ${quiz.index === 0 ? 'disabled' : ''}>Prev</button>
                 <button id="quiz-next">${quiz.index === quiz.questions.length - 1 ? 'Finish' : 'Next'}</button>
               </div>
             </div>`;
      qc.innerHTML = html;

      qc.querySelectorAll('button[data-answer-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const answerId = parseInt(btn.getAttribute('data-answer-id'), 10);
          quiz.answers[quiz.index] = { question_id: q.id, answer_id: answerId };
          renderQuizQuestion(); // re-render to highlight selection
        });
      });

      document.getElementById('quiz-prev').onclick = () => {
        if (quiz.index > 0) {
          quiz.index--;
          renderQuizQuestion();
        }
      };
      document.getElementById('quiz-next').onclick = () => {
        if (quiz.index < quiz.questions.length - 1) {
          quiz.index++;
          renderQuizQuestion();
        } else {
          renderQuizSummary();
        }
      };
    }

    function renderQuizSummary() {
      const qc = document.getElementById('quiz-content');
      const quiz = state.quiz;
      const questions = quiz.questions;
      const answerMap = new Map(quiz.answers.map(a => [a.question_id, a.answer_id]));

      let score = 0;
      const detailRows = questions.map(q => {
        const selectedId = answerMap.get(q.id);
        const selected = q.answers.find(a => a.id === selectedId);
        const correct = q.answers[0]; // or mark correct server-side and send; adjust as needed
        const isCorrect = selected && selected.id === correct.id;
        if (isCorrect) score++;
        return { q, selected, correct, isCorrect };
      });

      let html = `<h3>Quiz summary</h3>
                  <p>Score: ${score} / ${questions.length}</p>
                  <h4>Details</h4>
                  <ol>`;
      detailRows.forEach(row => {
        html += `<li>
                   <p><strong>Q:</strong> ${row.q.question_text}</p>
                   <p><strong>Your answer:</strong> ${row.selected ? row.selected.answer_text : 'No answer'} (${row.isCorrect ? 'correct' : 'wrong'})</p>
                   <p><strong>Correct answer:</strong> ${row.correct ? row.correct.answer_text : '-'}</p>
                 </li>`;
      });
      html += `</ol>
               <button id="retry-quiz">Retry quiz</button>`;
      qc.innerHTML = html;

      document.getElementById('retry-quiz').onclick = () => {
        state.quiz.index = 0;
        state.quiz.answers = [];
        renderQuizQuestion();
      };
    }

    loadCourses().catch(err => {
      console.error(err);
      document.getElementById('content-body').textContent = 'Failed to load courses.';
    });
  </script>
</body>
</html>
